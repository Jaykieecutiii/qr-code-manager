<!DOCTYPE html>
<html lang="vi">
<head>
    <meta name="theme-color" content="#222222">
    <title>Quét Mã Sản Phẩm</title>
    <style>
        /* ... (toàn bộ CSS từ file mobile_scan_screen.html lần trước giữ nguyên) ... */

        /* [MỚI] CSS cho các nút lựa chọn Nhập/Xuất và form số lượng */
        .scan-actions-container {
            position: fixed;
            bottom: 80px; /* Hoặc vị trí phù hợp, phía trên scan-footer */
            left: 15px;
            right: 15px;
            background-color: rgba(50, 50, 50, 0.95);
            color: var(--scanner-text-light);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            text-align: center;
        }
        .scan-actions-container p {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .scan-actions-container .action-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .scan-actions-container .btn-action {
            background-color: var(--primary-color); /* Màu nút từ style.css dashboard */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
            flex-grow: 1;
            margin: 0 5px;
        }
         .scan-actions-container .btn-action.btn-export { /* Màu khác cho nút xuất */
            background-color: #dc3545; /* Màu đỏ (danger) */
        }
        .scan-actions-container .quantity-form {
            margin-top: 10px;
        }
        .scan-actions-container .quantity-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .scan-actions-container .quantity-form input[type="number"] {
            width: 80px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--scanner-text-muted);
            text-align: center;
            margin-right: 10px;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="scan-container">
        <header class="scan-header">
            <a href="javascript:history.back()" class="back-button"><i class="fas fa-arrow-left"></i></a>
            <span class="title">Quét mã QR/Mã vạch</span>
            <button class="flashlight-button" id="flashlightToggle"><i class="fas fa-lightbulb"></i></button>
        </header>

        <div class="camera-viewport-container">
            <div id="qr-reader"></div>
            <div class="scan-overlay">
                <div class="scan-region-text">Di chuyển camera vào mã</div>
                <div class="scan-box">
                    <div class="laser"></div>
                </div>
            </div>
        </div>

        <div id="scan-result-and-actions" class="scan-actions-container hidden">
            <p id="scanned-product-name"><strong>Sản phẩm:</strong> <span></span></p>
            <p id="scanned-code-display"><strong>Mã quét:</strong> <span></span></p>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 10px 0;">
            <p>Bạn muốn làm gì với sản phẩm này?</p>
            <div class="action-buttons">
                <button class="btn-action" id="btnNhapHang">Nhập hàng</button>
                <button class="btn-action btn-export" id="btnXuatHang">Xuất hàng</button>
            </div>
            <div id="formNhapHang" class="quantity-form hidden">
                <label for="quantityNhap">Nhập số lượng NHẬP:</label>
                <div>
                    <input type="number" id="quantityNhap" name="quantityNhap" min="1" value="1">
                    <button class="btn-action" id="btnConfirmNhap">Xác nhận Nhập</button>
                </div>
            </div>
            <div id="formXuatHang" class="quantity-form hidden">
                <label for="quantityXuat">Nhập số lượng XUẤT:</label>
                <div>
                    <input type="number" id="quantityXuat" name="quantityXuat" min="1" value="1">
                    <button class="btn-action btn-export" id="btnConfirmXuat">Xác nhận Xuất</button>
                </div>
            </div>
            <p id="action-status" style="margin-top: 10px; font-size: 13px;"></p>
        </div>


        <footer class="scan-footer">
            <button class="scan-footer-button" id="uploadImageBtn">
                <i class="fas fa-image"></i>
                <span>Tải ảnh lên</span>
            </button>
            <button class="scan-footer-button" id="rescanBtn" style="display: none;"> <i class="fas fa-sync-alt"></i>
                <span>Quét lại</span>
            </button>
        </footer>
    </div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const qrReaderElement = document.getElementById('qr-reader');
            const scanResultAndActionsDiv = document.getElementById('scan-result-and-actions');
            const scannedProductNameEl = document.querySelector('#scanned-product-name span');
            const scannedCodeDisplayEl = document.querySelector('#scanned-code-display span');
            const actionStatusEl = document.getElementById('action-status');

            const btnNhapHang = document.getElementById('btnNhapHang');
            const btnXuatHang = document.getElementById('btnXuatHang');
            const formNhapHang = document.getElementById('formNhapHang');
            const formXuatHang = document.getElementById('formXuatHang');
            const quantityNhapInput = document.getElementById('quantityNhap');
            const quantityXuatInput = document.getElementById('quantityXuat');
            const btnConfirmNhap = document.getElementById('btnConfirmNhap');
            const btnConfirmXuat = document.getElementById('btnConfirmXuat');

            const flashlightToggle = document.getElementById('flashlightToggle');
            const uploadImageBtn = document.getElementById('uploadImageBtn');
            const rescanBtn = document.getElementById('rescanBtn');

            let html5QrCode;
            let isFlashlightOn = false;
            let currentStream = null;
            let lastScannedCode = null; // Lưu lại mã vừa quét
            let lastProductId = null; // Lưu lại ID sản phẩm nếu có

            // ... (config của html5-qrcode giữ nguyên như trước) ...
            const config = { fps: 10, qrbox: function(viewfinderWidth, viewfinderHeight) { let minEdge = Math.min(viewfinderWidth, viewfinderHeight); let qrboxSize = Math.floor(minEdge * 0.7); return { width: qrboxSize, height: qrboxSize * 0.6 }; }, formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.UPC_E], experimentalFeatures: { useBarCodeDetectorIfSupported: true } };

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                console.log(`Scan result: ${decodedText}`);
                lastScannedCode = decodedText; // Lưu mã
                actionStatusEl.textContent = ''; // Xóa trạng thái cũ

                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.pause(true);
                }
                uploadImageBtn.style.display = 'none'; // Ẩn nút tải ảnh
                rescanBtn.style.display = 'flex';   // Hiện nút quét lại

                // Gửi mã quét được lên server CHỈ ĐỂ LẤY THÔNG TIN SẢN PHẨM
                fetch("{{ url_for('get_product_info_from_scan') }}", { // ROUTE MỚI ĐỂ LẤY INFO
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scanned_data: decodedText })
                })
                .then(response => response.json())
                .then(data => {
                    scanResultAndActionsDiv.classList.remove('hidden');
                    if (data.error) {
                        scannedProductNameEl.textContent = 'Không tìm thấy';
                        scannedCodeDisplayEl.textContent = decodedText;
                        lastProductId = null;
                        actionStatusEl.innerHTML = `<span style="color:orange;">Sản phẩm không có trong hệ thống.</span>`;
                    } else {
                        scannedProductNameEl.textContent = data.product_name || 'Không rõ tên';
                        scannedCodeDisplayEl.textContent = decodedText;
                        lastProductId = data.product_id || null;
                        actionStatusEl.textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi lấy thông tin sản phẩm:', error);
                    scanResultAndActionsDiv.classList.remove('hidden');
                    scannedProductNameEl.textContent = 'Lỗi';
                    scannedCodeDisplayEl.textContent = decodedText;
                    actionStatusEl.innerHTML = `<span style="color:red;">Lỗi kết nối server khi lấy thông tin.</span>`;
                });
            };

            const qrCodeErrorCallback = (errorMessage) => { /* console.warn(errorMessage); */ };

            function startScan() {
                // ... (code hàm startScan giữ nguyên như trước, ưu tiên camera sau) ...
                // ... chỉ bỏ phần gửi fetch đến process_and_log_scan ...
                if (!html5QrCode) { html5QrCode = new Html5Qrcode("qr-reader", { verbose: false, experimentalFeatures: { useBarCodeDetectorIfSupported: true } });}
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback, qrCodeErrorCallback)
                .then(() => { /* ... */ const videoElement = document.getElementById('qr-reader-video'); if (videoElement && videoElement.srcObject) { currentStream = videoElement.srcObject; }})
                .catch(err => { html5QrCode.start({ facingMode: "user" }, config, qrCodeSuccessCallback, qrCodeErrorCallback).then(/*...*/).catch(/*...*/);});
            }
            startScan(); // Bắt đầu quét

            // --- Xử lý các nút hành động ---
            btnNhapHang.addEventListener('click', () => {
                formNhapHang.classList.remove('hidden');
                formXuatHang.classList.add('hidden');
                quantityNhapInput.focus();
            });

            btnXuatHang.addEventListener('click', () => {
                formXuatHang.classList.remove('hidden');
                formNhapHang.classList.add('hidden');
                quantityXuatInput.focus();
            });

            function handleInventoryAction(actionType, quantity) {
                if (!lastScannedCode) {
                    actionStatusEl.innerHTML = `<span style="color:red;">Lỗi: Không có mã nào được quét.</span>`;
                    return;
                }
                actionStatusEl.textContent = `Đang ${actionType === 'nhap' ? 'nhập' : 'xuất'} kho...`;

                fetch("{{ url_for('update_inventory_and_log') }}", { // ROUTE MỚI ĐỂ CẬP NHẬT KHO VÀ LOG
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scanned_data: lastScannedCode,
                        product_id: lastProductId, // Gửi ID sản phẩm nếu có
                        product_name: scannedProductNameEl.textContent, // Gửi tên sản phẩm đã hiển thị
                        action: actionType, // 'nhap' hoặc 'xuat'
                        quantity: quantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        actionStatusEl.innerHTML = `<span style="color:red;">Lỗi ${actionType === 'nhap' ? 'nhập' : 'xuất'} kho: ${data.error}</span>`;
                    } else {
                        actionStatusEl.innerHTML = `<span style="color:green;">${data.message}</span>`;
                        // Reset UI để quét tiếp
                        setTimeout(() => {
                            resetScanUI();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error(`Lỗi khi ${actionType} kho:`, error);
                    actionStatusEl.innerHTML = `<span style="color:red;">Lỗi kết nối server khi ${actionType} kho.</span>`;
                });
            }

            btnConfirmNhap.addEventListener('click', () => {
                const quantity = parseInt(quantityNhapInput.value);
                if (quantity > 0) {
                    handleInventoryAction('nhap', quantity);
                } else {
                    actionStatusEl.innerHTML = `<span style="color:red;">Số lượng nhập phải lớn hơn 0.</span>`;
                }
            });

            btnConfirmXuat.addEventListener('click', () => {
                const quantity = parseInt(quantityXuatInput.value);
                if (quantity > 0) {
                    handleInventoryAction('xuat', quantity);
                } else {
                    actionStatusEl.innerHTML = `<span style="color:red;">Số lượng xuất phải lớn hơn 0.</span>`;
                }
            });

            function resetScanUI() {
                scanResultAndActionsDiv.classList.add('hidden');
                formNhapHang.classList.add('hidden');
                formXuatHang.classList.add('hidden');
                quantityNhapInput.value = '1';
                quantityXuatInput.value = '1';
                actionStatusEl.textContent = '';
                lastScannedCode = null;
                lastProductId = null;
                uploadImageBtn.style.display = 'flex';
                rescanBtn.style.display = 'none';
                if (html5QrCode && html5QrCode.isScanning === false) {
                    try { html5QrCode.resume(); } catch(e) { console.error("Error resuming for new scan:", e)}
                }
            }

            rescanBtn.addEventListener('click', resetScanUI);


            // ... (code flashlightToggle, uploadImageBtn, beforeunload giữ nguyên như trước) ...
             flashlightToggle.addEventListener('click', () => { if (currentStream) { const track = currentStream.getVideoTracks()[0]; if (track.getCapabilities().torch) { isFlashlightOn = !isFlashlightOn; track.applyConstraints({ advanced: [{torch: isFlashlightOn}] }).then(() => { flashlightToggle.style.color = isFlashlightOn ? 'var(--scanner-highlight)' : 'var(--scanner-text-light)'; }).catch(e => console.error(e)); } else { alert('Không hỗ trợ đèn pin.'); } } else { alert('Camera chưa sẵn sàng.'); } });
             if (uploadImageBtn) { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.style.display = 'none'; document.body.appendChild(fileInput); uploadImageBtn.addEventListener('click', () => { fileInput.click(); }); fileInput.addEventListener('change', event => { const file = event.target.files[0]; if (file && html5QrCode) { if (html5QrCode.isScanning) { html5QrCode.pause(true); } html5QrCode.scanFile(file, true).then(decodedText => { qrCodeSuccessCallback(decodedText, { decodedText: decodedText }); }).catch(err => { actionStatusEl.textContent = `Lỗi quét ảnh: ${err}`; actionStatusEl.classList.remove('hidden'); console.error(err);}).finally(() => { fileInput.value = ''; }); } }); }
             window.addEventListener('beforeunload', () => { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => console.error(err)); } });

        });
    </script>
</body>
</html>